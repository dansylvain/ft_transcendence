{% load static %}
<div id="overview-content" class="container-fluid px-0 mt-4">
  <!-- Top card -->
  <div class="row">
    <!--Card number one-->
    <div class="poly-card d-flex mb-4">
      <!-- First section: Games Played -->
      <div class="games-stat text-center">
        <p class="label-text mb-1">Games Played</p>
        <h1 class="stats-top-number mb-1 mt-1">
          {{ main_stats.games_played }}
        </h1>
        <div class="accent-bar mx-auto mt-1"></div>
      </div>
      <div class="small-vertical-accent-bar mx-3"></div>
      <!-- Second section: Games Won -->
      <div class="games-stat text-center">
        <p class="label-text mb-1">Games Won</p>
        <h1 class="stats-top-number mb-1 mt-1">{{ main_stats.games_won }}</h1>
        <div class="accent-bar mx-auto mt-1"></div>
      </div>
      <div class="big-vertical-accent-bar mx-3"></div>
      <!-- Third section: Tournaments Played -->
      <div class="games-stat text-center">
        <p class="label-text mb-1">Tournaments Played</p>
        <h1 class="stats-top-number mb-1 mt-1">
          {{ main_stats.nb_tournaments_played }}
        </h1>
        <div class="accent-bar mx-auto mt-1"></div>
      </div>
      <div class="small-vertical-accent-bar mx-3"></div>
      <!-- Fourth section: Tournaments Won -->
      <div class="games-stat text-center">
        <p class="label-text mb-1">Tournaments Won</p>
        <h1 class="stats-top-number mb-1 mt-1">
          {{ main_stats.nb_tournaments_won}}
        </h1>
        <div class="accent-bar mx-auto mt-1"></div>
      </div>
    </div>

    <!-- card number 2-->
    <div class="poly-card d-flex col-12 mx-auto py-2 thinner-card mb-4">
      <!-- First section: Current Win Streak -->
      <div class="streak-stat text-center">
        <p class="label-text mb-1">Best win streak</p>
        <h1 class="stats-top-number smaller-stats-top-number mb-1 mt-1">
          {{ main_stats.best_win_streak }}
        </h1>
        <div class="accent-bar mx-auto mt-1"></div>
      </div>
      <div class="small-vertical-accent-bar mx-3"></div>
      <!-- Second section: Best Win Streak -->
      <div class="streak-stat text-center">
        <p class="label-text mb-1">Current win Streak</p>
        <h1 class="stats-top-number smaller-stats-top-number mb-1 mt-1">
          {{ main_stats.c_win_streak }}
        </h1>
        <div class="accent-bar mx-auto mt-1"></div>
      </div>
      <div class="big-vertical-accent-bar mx-3"></div>
      <!-- Third section: Worst lose Streak -->
      <div class="streak-stat text-center">
        <p class="label-text mb-1">Worst lose streak</p>
        <h1 class="stats-top-number smaller-stats-top-number mb-1 mt-1">
          {{ main_stats.worst_lose_streak }}
        </h1>
        <div class="accent-bar mx-auto mt-1"></div>
      </div>
      <div class="small-vertical-accent-bar mx-3"></div>
      <!-- Fourth section: Current Lose Streak -->
      <div class="streak-stat text-center">
        <p class="label-text mb-1">Current lose Streak</p>
        <h1 class="stats-top-number smaller-stats-top-number mb-1 mt-1">
          {{ main_stats.c_lose_streak }}
        </h1>
        <div class="accent-bar mx-auto mt-1"></div>
      </div>
    </div>
  </div>

  <div class="row mt-4">
    <!-- Games Won / Lost Pie Chart Card -->
    <div class="col-md-6 mb-4">
      <div class="poly-card text-center">
        <p class="label-text mb-1">Win / Loss</p>
        <div class="pie-chart-container">
          <canvas id="gamesPie"></canvas>
          <div class="chart-center-label">
            {{ main_stats.win_rate }}%
            <div class="inside-doughnut-text">Win Rate</div>
          </div>
        </div>
        <hr />
        <div class="chart-stats-container">
          <p>
            <span data-translate="Games won: ">Games won: </span>
            <span class="text-primary">{{ main_stats.games_won }}</span>
          </p>
          <p>
            <span data-translate="Games lost: ">Games lost: </span>
            <span class="text-danger">{{ main_stats.games_lost }}</span>
          </p>
        </div>
      </div>
    </div>

    <!-- Points Scored / Conceded Pie Chart Card -->
    <div class="col-md-6 mb-4">
      <div class="poly-card text-center">
        <p class="label-text mb-1">Scoring</p>
        <div class="pie-chart-container">
          <canvas id="pointsPie"></canvas>
          <div class="chart-center-label">
            {{ main_stats.average_score }}
            <div class="inside-doughnut-text">Average Score</div>
          </div>
        </div>
        <hr />
        <div class="chart-stats-container">
          <p>
            <span data-translate="Points Scored: ">Scored: </span>
            <span class="text-primary">{{ main_stats.points_scored }}</span>
          </p>
          <p>
            <span data-translate="Points Conceded: ">Conceded: </span>
            <span class="text-danger">{{ main_stats.points_conceded }}</span>
          </p>
        </div>
      </div>
    </div>
    <!-- end chart 2-->
  </div>
</div>

<!-- Use json_script to safely pass main_stats to JavaScript -->
{{ main_stats|json_script:"mainStats" }}
<script src="{% static 'static_files/vendor/chart.js/Chart.min.js' %}"></script>

<script>
  // Helper function to initialize charts
  function initializeCharts() {
    const gamesPie = document.getElementById("gamesPie")?.getContext("2d");
    const pointsPie = document.getElementById("pointsPie")?.getContext("2d");

    // Get the data from the JSON script
    const mainStats = JSON.parse(
      document.getElementById("mainStats").textContent
    );

    if (gamesPie && pointsPie) {
      const gamesPlayed = mainStats.games_played;
      const gamesWon = mainStats.games_won;
      const gamesLost = mainStats.games_lost;
      const winRate = mainStats.win_rate;
      const averageScore = mainStats.average_score;
      const pointsScored = mainStats.points_scored;
      const pointsConceded = mainStats.points_conceded;

      function addDummyIfZero(data, labels) {
        if (data.every((value) => value === 0)) {
          data.push(1); // dummy value to ensure doughnut doesn't collapse
          labels.push("No Data"); // dummy label for the dummy value
        }
      }

      // Games Won/Lost Data
      const gamesData = [gamesWon, gamesLost];
      const gamesLabels = ["Games Won", "Games Lost"];
      addDummyIfZero(gamesData, gamesLabels);

      // Points Scored/Conceded Data
      const pointsData = [pointsScored, pointsConceded];
      const pointsLabels = ["Points Scored", "Points Conceded"];
      addDummyIfZero(pointsData, pointsLabels);

      // Options for the charts
      const chartOptions = {
        maintainAspectRatio: false,
        tooltips: {
          backgroundColor: "rgb(255,255,255)",
          bodyFontColor: "#858796",
          borderColor: "#5a5c69",
          borderWidth: 1,
          xPadding: 15,
          yPadding: 15,
          displayColors: false,
          caretPadding: 10,
          filter: function (item, chart) {
            return chart.labels[item.index] !== "No Data";
          },
        },
        legend: {
          display: false,
          labels: {
            filter: (item) =>
              item.text !== undefined && item.text !== "No Data",
          },
        },
        cutoutPercentage: 80,
        animation: {
          animateScale: true,
          animateRotate: true,
        },
        responsive: true,
      };

      // Create the Games Won/Lost Pie Chart
      new Chart(gamesPie, {
        type: "doughnut",
        data: {
          labels: gamesLabels,
          datasets: [
            {
              data: gamesData,
              backgroundColor: ["#007bff", "#ff4d4d"],
              hoverBorderColor: "#5a5c69",
              borderColor: "#5a5c69",
              borderWidth: 2,
            },
          ],
        },
        options: chartOptions,
      });

      // Create the Points Scored/Conceded Pie Chart
      new Chart(pointsPie, {
        type: "doughnut",
        data: {
          labels: pointsLabels,
          datasets: [
            {
              data: pointsData,
              backgroundColor: ["#007bff", "#ff4d4d"],
              hoverBorderColor: "#5a5c69",
              borderColor: "#5a5c69",
              borderWidth: 2,
            },
          ],
        },
        options: chartOptions,
      });
    }
  }

  document.addEventListener("DOMContentLoaded", function () {
    initializeCharts();
  });

  document.body.addEventListener("htmx:afterSwap", function (event) {
    initializeCharts();
  });
</script>

<style>
  /*Chart stat cotnainer */
  .chart-stats-container {
    font-size: 1.2rem;
    font-weight: 700;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    margin-top: 1rem;
  }

  .chart-stats-container p {
    margin: 0.5rem 0;
  }

  .chart-stats-container p span {
    display: inline-block;
    text-align: center;
  }

  .chart-stats-container span {
    color: #858796;
  }
</style>

<style>
  .poly-card {
    justify-content: space-between;
    background: rgba(255, 255, 255, 0.15);
    backdrop-filter: blur(24px) saturate(160%);
    -webkit-backdrop-filter: blur(24px) saturate(160%);
    border: 1px solid rgba(255, 255, 255, 0.3);
    border-radius: 1.25rem;
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.12);
    padding: 1rem;
    width: 100%;
    align-items: center;
  }

  .games-stat {
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    flex: 1;
  }

  .streak-stat {
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    flex: 1;
  }

  .label-text {
    font-size: 0.8rem;
    color: #858796;
    font-weight: 800;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .stats-top-number {
    font-size: 3rem;
    font-weight: 800;
    color: #5a5c69;
    max-width: 100%;
  }

  .smaller-stats-top-number {
    font-size: 2.2rem; /* Reduced size for smaller stats */
  }

  .vertical-accent-bar {
    width: 0.3rem;
    background: #4e73df;
    border-radius: 2px;
  }

  .small-vertical-accent-bar {
    width: 0.3rem;
    background: #4e73df;
    border-radius: 2px;
    height: 2rem;
  }

  .big-vertical-accent-bar {
    width: 0.3rem;
    background: #4e73df;
    border-radius: 2px;
    height: 4rem;
  }

  .accent-bar {
    height: 4px;
    width: 5rem;
    background: #4e73df;
    border-radius: 2px;
  }

  .text-primary {
    font-size: 1.2rem;
    font-weight: 700;
    color: #4e73df;
  }

  .text-danger {
    font-size: 1.2rem;
    font-weight: 700;
    color: #e74a3b;
  }

  .pie-chart-container {
    position: relative;
    width: 100%;
    height: 300px;
  }

  .chart-center-label {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 1.5rem;
    font-weight: bold;
    color: #858796;
  }

  body {
    background: linear-gradient(145deg, #e2e8f0, #f1f5f9);
  }

  .game-stats-container {
    font-size: 1.2rem;
    font-weight: 700;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    height: 150px;
    width: 100%;
    margin-top: 1rem;
  }

  .game-stats-container p {
    margin: 0.5rem 0;
  }

  .game-stats-container p span {
    display: inline-block;
    text-align: center;
  }

  .game-stats-container span {
    color: #858796;
  }

  .poly-card.col-6 {
    max-width: 50%;
  }

  .row {
    margin-top: 20px;
  }
</style>
