<div class="container">

    <!-- Outer Row -->
    <div class="row justify-content-center">

        <div class="col-xl-10 col-lg-12 col-md-9">

            <div class="card o-hidden border-0 shadow-lg my-5">
                <div class="card-body p-0">
                    <!-- Nested Row within Card Body -->
                    <div class="row">
                        <div class="col-lg-6 d-none d-lg-block bg-login-image"></div>
                        <div class="col-lg-6">
                            <div class="p-5">
                                <div class="text-center">
                                    <h1 class="h4 text-gray-900 mb-4">Welcome Back!</h1>
                                </div>
                                <form class="user" 
                                method="post" 
                                action="/auth/login/">
									{% csrf_token %}
                                    <div class="form-group">
                                        <input type="text" 
                                        class="form-control form-control-user"
                                        id="username" 
                                        name="username"
                                        placeholder="Enter Username...">
                                    </div>
                                    <div class="form-group">
                                        <input type="password" 
                                        class="form-control form-control-user"
                                        id="password" 
                                        name="password" 
                                        placeholder="Password">
                                    </div>
                                    <div class="form-group">
                                    </div>
									<div class="form-group">
										<input 
                                        type="submit" 
                                        class="btn btn-primary btn-user btn-block" 
                                        value="Logiiiiiiiin">
									</div>
                                    <hr>
                                    <a hx-boost="false" 
                                    href="http://localhost:8000/home/" 
                                    class="btn btn-google btn-user btn-block">
                                        <i class="fab fa-google fa-fw"></i> 
                                        Login with Google
                                    </a>
                                    <a hx-boost="false" 
                                    href="http://localhost:8000/home/" 
                                    class="btn btn-facebook btn-user btn-block">
                                        <i class="fab fa-facebook-f fa-fw"></i> 
                                        Login with Facebook
                                    </a>
                                </form>
                                <hr>
                                <div class="text-center">
                                    <a class="small" 
                                    hx-boost="false" 
                                    href="http://localhost:8000/forgot-password">
                                    Forgot Password?
                                    </a>
                                </div>
                                <div class="text-center">
                                    <a class="small" 
                                    hx-boost="false" 
                                    href="http://localhost:8000/register">
                                    Create an Account!
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>

    </div>

		<!-- Add this script before the closing </div> of the container -->
	<script>
	document.addEventListener('DOMContentLoaded', function() {
		const loginForm = document.querySelector('form.user');
		
		loginForm.addEventListener('submit', async function(e) {
			e.preventDefault(); // Prevent normal form submission
			
			const formData = new FormData(loginForm);
			
			try {
				const response = await fetch('/auth/login/', {
					method: 'POST',
					body: formData,
					credentials: 'include'  // ðŸ”¥ Ensure cookies are included in requests!
				});
				
				// Check if response is JSON
				const contentType = response.headers.get('content-type');
				let data;
				
				if (contentType && contentType.includes('application/json')) {
					data = await response.json();
				} else {
					console.error('Expected JSON response but got:', contentType);
					data = { success: false, error: 'Unexpected response format' };
				}
				
				// Check for cookies in the response
				console.log('Response cookies (via document.cookie):', document.cookie);
				
				if (data.success) {
					// Log success before redirecting
					console.log('Login successful, redirecting to:', data.redirect_to);
					
					// Store tokens in localStorage for the Authorization header approach
					// Note: This is less secure than HttpOnly cookies but provides flexibility
					if (data.access_token && data.refresh_token) {
						localStorage.setItem('access_token', data.access_token);
						localStorage.setItem('refresh_token', data.refresh_token);
						localStorage.setItem('token_type', data.token_type || 'Bearer');
						console.log('Tokens stored in localStorage for API requests');
					}
					
					// Small delay to ensure cookies are set
					setTimeout(() => {
						window.location.href = data.redirect_to;
					}, 100);
				} else {
					console.error('Login failed:', data.error);
					alert(data.error || 'Login failed');
				}
			} catch (error) {
				console.error('Login error:', error);
				alert('An error occurred during login. Please try again.');
			}
		});
	});
	
	// Helper function to add Authorization header to fetch requests
	function fetchWithAuth(url, options = {}) {
		const token = localStorage.getItem('access_token');
		const tokenType = localStorage.getItem('token_type') || 'Bearer';
		
		if (!options.headers) {
			options.headers = {};
		}
		
		if (token) {
			options.headers.Authorization = `${tokenType} ${token}`;
		}
		
		// Always include credentials for cookies
		options.credentials = 'include';
		
		return fetch(url, options);
	}
	</script>

</div>