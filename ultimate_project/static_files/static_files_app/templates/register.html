{% load static %}
<div class="container">

	<div class="card o-hidden border-0 shadow-lg my-5">
		<div class="card-body p-0">
			<!-- Nested Row within Card Body -->
			<div class="row">
				<div class="col-lg-5 d-none d-lg-block bg-register-image"></div>
				<div class="col-lg-7">
					<div class="p-5">
						<div class="text-center">
							<h1 class="h4 text-gray-900 mb-4">
								Create an Account!
							</h1>
						</div>
						<!-- Formulaire de cr√©ation de compte HTMX -->
						<form 
							id="register-form" 
							class="user" 
							hx-post="/auth/register/" 
							hx-target="#register-form" 
							hx-swap="outerHTML" 
							hx-indicator="#loading-spinner"
							>

							<!-- HTMX loading indicator -->
							<div class="htmx-indicator" style="display:none;">
								Processing registration...
							</div>
							
							<!-- First Name et Last Name -->
							<div class="form-group row">
								<div class="col-sm-6 mb-3 mb-sm-0">
									<input type="text" class="form-control form-control-user" id="first_name"
									name="first_name" placeholder="First Name" required>
								</div>
								<div class="col-sm-6">
									<input type="text" class="form-control form-control-user" id="last_name"
									name="last_name" placeholder="Last Name" required>
								</div>
							</div>
							
							<!-- Username et Email -->
							<div class="form-group row">
								<div class="col-sm-6 mb-3 mb-sm-0">
									<input type="text" class="form-control form-control-user" id="username"
									name="username" placeholder="Username" required>
								</div>
								<div class="col-sm-6">
									<input type="email" class="form-control form-control-user" id="email"
									name="email" placeholder="Email" required>
								</div>
								</div>
							
								<!-- Password et Repeat Password -->
							<div class="form-group row">
								<div class="col-sm-6 mb-3 mb-sm-0">
									<input type="password" class="form-control form-control-user" id="password"
										name="password" placeholder="Password" required>
								</div>
								<div class="col-sm-6">
									<input type="password" class="form-control form-control-user" id="repeat_password"
										name="repeat_password" placeholder="Repeat Password" required>
									<div id="password-error" class="text-danger small mt-1" style="display: none;">
										Passwords do not match
									</div>
								</div>
							</div>

							<!-- Zone de feedback pour les erreurs -->
							<div id="email-error" class="text-danger small mb-3" style="display: none;">
								Please enter a valid email address
							</div>

							<!-- Bouton de cr√©ation de compte -->	
							<button 
								type="submit" 
								class="btn btn-primary btn-user btn-block" 
								id="register-button">
								Register Account
							</button>
							<div id="loading-spinner" class="htmx-indicator text-center my-2">
								<div class="spinner-border text-primary" role="status">
									<span class="sr-only">Loading...</span>
								</div>
							</div>
							<hr>

							<!-- !  Google button  -->
							<!-- <a hx-boost="false" href="http://localhost:8000/home/"
								class="btn btn-google btn-user btn-block">
								<i class="fab fa-google fa-fw"></i>
								Register with Google
							</a> -->

							<!-- !  Facebook button  -->
							<!-- <a hx-boost="false" href="http://localhost:8000/home/"
								class="btn btn-facebook btn-user btn-block">
								<i class="fab fa-facebook-f fa-fw"></i>
								Register with Facebook
							</a> -->
						</form>
						<hr>
						<!-- <div class="text-center">
							<a hx-boost="false" class="small" href="http://localhost:8000/forgot-password">
								Forgot Password?
							</a>
						</div> -->
						<div hx-boost="false"
                                hx-trigger="click"
                                hx-push-url="true"
                                hx-get="/login/"
                                hx-target="body"
                                class="text-center small"
                                href="" 
                                data-translate="Already have an account? Login!">Already have an account? Login!
                            </div>
					</div>
				</div>
			</div>
		</div>
	</div>

</div>

<!-- Add JavaScript for client-side validation -->
<script>
	// HTMX event listeners for debugging
	document.addEventListener('DOMContentLoaded', function() {
		const firstNameInput = document.getElementById('first_name');
		const lastNameInput = document.getElementById('last_name');
		const usernameInput = document.getElementById('username');
		const emailInput = document.getElementById('email');
		const passwordInput = document.getElementById('password');
		const repeatPasswordInput = document.getElementById('repeat_password');
		const emailError = document.getElementById('email-error');
		const passwordError = document.getElementById('password-error');
		const registerButton = document.getElementById('register-button');
		const form = document.querySelector('form.user');

		// Email validation function
		function validateEmail(email) {
			const re = /^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
			return re.test(String(email).toLowerCase());
		}

		// Check email format
		emailInput.addEventListener('blur', function() {
			if (emailInput.value && !validateEmail(emailInput.value)) {
				emailError.style.display = 'block';
			} else {
				emailError.style.display = 'none';
			}
			validateForm();
		});

		// Check if passwords match
		function checkPasswords() {
			if (passwordInput.value && repeatPasswordInput.value) {
				if (passwordInput.value !== repeatPasswordInput.value) {
					passwordError.style.display = 'block';
					return false;
				} else {
					passwordError.style.display = 'none';
					return true;
				}
			}
			return passwordInput.value === repeatPasswordInput.value;
		}

		repeatPasswordInput.addEventListener('input', function() {
			checkPasswords();
			validateForm();
		});
		
		passwordInput.addEventListener('input', function() {
			checkPasswords();
			validateForm();
		});

		// Add input event listeners to all required fields
		firstNameInput.addEventListener('input', validateForm);
		lastNameInput.addEventListener('input', validateForm);
		usernameInput.addEventListener('input', validateForm);
		emailInput.addEventListener('input', validateForm);

		// Validate the entire form and enable/disable the register button
		function validateForm() {
			const isFirstNameValid = firstNameInput.value.trim() !== '';
			const isLastNameValid = lastNameInput.value.trim() !== '';
			const isUsernameValid = usernameInput.value.trim() !== '';
			const isEmailValid = emailInput.value && validateEmail(emailInput.value);
			const isPasswordValid = passwordInput.value.trim() !== '';
			const doPasswordsMatch = checkPasswords();

			const isFormValid = isFirstNameValid && 
								isLastNameValid && 
								isUsernameValid && 
								isEmailValid && 
								isPasswordValid && 
								doPasswordsMatch;

			console.log('Form validation:', {
				isFirstNameValid,
				isLastNameValid,
				isUsernameValid,
				isEmailValid,
				isPasswordValid,
				doPasswordsMatch,
				isFormValid
			});
			
			registerButton.disabled = !isFormValid;
			
			return isFormValid;
		}

		// Form submission validation
		form.addEventListener('htmx:beforeSwap', function(evt) {
			console.log("document.addEventListener working")
			if (evt.detail.target.id === 'register-form') {
				try {
					console.log("R√©ponse brute:", evt.detail.xhr.responseText);  // üîç Debug
					const response = JSON.parse(evt.detail.xhr.responseText);
					
					
					if (response.success) {
						evt.detail.shouldSwap = false;


						htmx.ajax('GET', '/home/', {
						target: 'body',
						swap: 'outerHTML',
						headers: {'HX-Login-Success': 'true'}
						}).then(function() {
							history.pushState(null, '', '/home/');
						});

					} else {
						
						evt.detail.innerHTML = response.message;  // Afficher erreur de connexion
					}
				} catch (e) {
					console.error('Erreur de traitement de la r√©ponse:', e);
				}
			}
			// console.log('Form submission triggered');
			// // Don't prevent default - let HTMX handle the submission
			// validateForm();
			// console.log('Form validation status:', !registerButton.disabled);
			
			// // Log form data that will be sent
			// const formData = new FormData(form);
			// const formValues = {};
			// for (let [key, value] of formData.entries()) {
			// 	formValues[key] = value;
			// }
			// console.log('Form data being submitted:', formValues);
		});
	});
</script>
